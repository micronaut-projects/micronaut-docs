<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script src="/cdn-cgi/apps/head/3cOPSgo5Omz84ycX7CvigfX4cpw.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-82213539-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-82213539-2');
    </script>
    <title>8 Cloud Native Features 2.1.0.BUILD-SNAPSHOT</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="https://docs.micronaut.io/docsassets/css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="https://docs.micronaut.io/docsassets/css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/quickStart.html"><strong>2</strong><span>Quick Start</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/ioc.html"><strong>3</strong><span>Inversion of Control</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/config.html"><strong>4</strong><span>Application Configuration</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/aop.html"><strong>5</strong><span>Aspect Oriented Programming</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/httpServer.html"><strong>6</strong><span>The HTTP Server</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/httpClient.html"><strong>7</strong><span>The HTTP Client</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/cloud.html"><strong>8</strong><span>Cloud Native Features</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/serverlessFunctions.html"><strong>9</strong><span>Serverless Functions</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/messaging.html"><strong>10</strong><span>Message-Driven Microservices</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/commandLineApps.html"><strong>11</strong><span>Standalone Command Line Applications</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/configurations.html"><strong>12</strong><span>Configurations</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/languageSupport.html"><strong>13</strong><span>Language Support</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/management.html"><strong>14</strong><span>Management &amp; Monitoring</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/security.html"><strong>15</strong><span>Security</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/multitenancy.html"><strong>16</strong><span>Multi-Tenancy</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/cli.html"><strong>17</strong><span>Micronaut CLI</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/i18n.html"><strong>18</strong><span>Internationalization</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/appendix.html"><strong>19</strong><span>Appendices</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/httpClient.html">&lt;&lt; <strong>7</strong><span>The HTTP Client</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/serverlessFunctions.html"><strong>9</strong><span>Serverless Functions</span> >></a></div>
                


                <div class="project">
                    <h1>8 Cloud Native Features</h1>

                    <p><strong>Version:</strong> 2.1.0.BUILD-SNAPSHOT</p>
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#cloudConfiguration"><strong>8.1</strong><span>Cloud Configuration</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#distributedConfiguration"><strong>8.1.1</strong><span>Distributed Configuration</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#distributedConfigurationConsul"><strong>8.1.2</strong><span>HashiCorp Consul Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#distributedConfigurationVault"><strong>8.1.3</strong><span>HashiCorp Vault Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#distributedConfigurationSpringCloud"><strong>8.1.4</strong><span>Spring Cloud Config Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#distributedConfigurationAwsParameterStore"><strong>8.1.5</strong><span>AWS Parameter Store Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#distributedConfigurationOracleCloudVault"><strong>8.1.6</strong><span>Oracle Cloud Vault Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#serviceDiscovery"><strong>8.2</strong><span>Service Discovery</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#serviceDiscoveryConsul"><strong>8.2.1</strong><span>Consul Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#serviceDiscoveryEureka"><strong>8.2.2</strong><span>Eureka Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#serviceDiscoveryKubernetes"><strong>8.2.3</strong><span>Kubernetes Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#serviceDiscoveryRoute53"><strong>8.2.4</strong><span>AWS Route 53 Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#serviceDiscoveryManual"><strong>8.2.5</strong><span>Manual Service Discovery Configuration</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#clientSideLoadBalancing"><strong>8.3</strong><span>Client Side Load Balancing</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#netflixRibbon"><strong>8.3.1</strong><span>Netflix Ribbon Support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#distributedTracing"><strong>8.4</strong><span>Distributed Tracing</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#zipkin"><strong>8.4.1</strong><span>Tracing with Zipkin</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#jaeger"><strong>8.4.2</strong><span>Tracing with Jaeger</span></a>
                    </div>
                    
                </div>
                

                
<h1 id="cloud"><a class="anchor" href="#cloud"></a>8 Cloud Native Features</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The majority of frameworks in use today on the JVM were designed before the rise of cloud deployments and microservice architectures. Applications built with these frameworks were intended to be deployed to traditional Java containers. As a result, cloud support in these frameworks typically comes as an add-on rather than as core design features.</p>
</div>
<div class="paragraph">
<p>Micronaut was designed from the ground up for building microservices for the cloud. As a result, many key features that typically require external libraries or services are available within your application itself.  To override one of the industry&#8217;s current favorite buzzwords, Micronaut applications are "natively cloud-native".</p>
</div>
<div class="paragraph">
<p>The following are some of the cloud-specific features that are integrated directly into the Micronaut runtime:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Distributed Configuration</p>
</li>
<li>
<p>Service Discovery</p>
</li>
<li>
<p>Client-Side Load-Balancing</p>
</li>
<li>
<p>Distributed Tracing</p>
</li>
<li>
<p>Serverless Functions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Many of the features in Micronaut and heavily inspired by features from Spring and Grails. This is by design and helps developers who are already familiar with systems such as Spring Cloud.</p>
</div>
<div class="paragraph">
<p>The following sections cover these features and how to use them.</p>
</div>

<h2 id="cloudConfiguration"><a class="anchor" href="#cloudConfiguration"></a>8.1 Cloud Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/cloudConfiguration.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Applications that are built for the Cloud often need adapt to running in a Cloud environment, read and share configuration in a distributed manner and externalize configuration to the environment where necessary.</p>
</div>
<div class="paragraph">
<p>Micronaut&#8217;s <a href="#environments">Environment</a> concept is by default Cloud platform aware and will make a best effort to detect the underlying active environment.</p>
</div>
<div class="paragraph">
<p>You can then use the <a href="../api/io/micronaut/context/annotation/Requires.html">Requires</a> annotation to <a href="#conditionalBeans">conditionally load bean definitions</a>.</p>
</div>
<div class="paragraph">
<p>The following table summarizes the constants provided by the <a href="../api/io/micronaut/context/env/Environment.html">Environment</a> interface and provides an example:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Micronaut Environment Detection</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Constant</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Requires Example</th>
<th class="tableblock halign-left valign-top">Environment name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#ANDROID">ANDROID</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The application is running as an Android application</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.ANDROID)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>android</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#TEST">TEST</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The application is running within a JUnit or Spock test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.TEST)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>test</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#CLOUD">CLOUD</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The application is running in a Cloud environment (present for all other cloud platform types)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.CLOUD)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cloud</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#AMAZON_EC2">AMAZON_EC2</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running on <a href="https://aws.amazon.com/ec2">Amazon EC2</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.AMAZON_EC2)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ec2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#GOOGLE_COMPUTE">GOOGLE_COMPUTE</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running on <a href="https://cloud.google.com/compute/">Google Compute</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.GOOGLE_COMPUTE)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gcp</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#KUBERNETES">KUBERNETES</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running on <a href="https://www.kubernetes.io">Kubernetes</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.KUBERNETES)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>k8s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#HEROKU">HEROKU</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running on <a href="https://heroku.com">Heroku</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.HEROKU)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>heroku</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#CLOUD_FOUNDRY">CLOUD_FOUNDRY</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running on <a href="https://www.cloudfoundry.org">Cloud Foundry</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.CLOUD_FOUNDRY)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pcf</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#AZURE">AZURE</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running on <a href="https://azure.microsoft.com">Microsoft Azure</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.AZURE)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>azure</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#IBM">IBM</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running on <a href="https://www.ibm.com/cloud/">IBM Cloud</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.IBM)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ibm</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#DIGITAL_OCEAN">DIGITAL_OCEAN</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running on <a href="https://www.digitalocean.com/">Digital Ocean</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.DIGITAL_OCEAN)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>digitalocean</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="../api/io/micronaut/context/env/Environment.html#ORACLE_CLOUD">ORACLE_CLOUD</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running on <a href="https://cloud.oracle.com/">Oracle Cloud</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Requires(env = Environment.ORACLE_CLOUD)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>oraclecloud</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that it may be the case that you have multiple active environment names since you may run Kubernetes on AWS for example.</p>
</div>
<div class="paragraph">
<p>In addition, using the value of the constants defined in the table above you can create environment specific configuration files. For example if you create a <code>src/main/resources/application-gcp.yml</code> file then that configuration will only be loaded when running on Google Compute.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Any configuration property in the <a href="../api/io/micronaut/context/env/Environment.html">Environment</a> can also be set via an environment variable. For example, setting the <code>CONSUL_CLIENT_HOST</code> environment variable will override the <code>host</code> property in <a href="../api/io/micronaut/discovery/consul/ConsulConfiguration.html">ConsulConfiguration</a>.
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="_using_cloud_instance_metadata">Using Cloud Instance Metadata</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When Micronaut detects it is running on any of the cloud platforms listed above, such as Google Compute or AWS EC2, upon startup Micronaut will populate the interface <a href="../api/io/micronaut/discovery/cloud/ComputeInstanceMetadata.html">ComputeInstanceMetadata</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
As of Micronaut 2.1.x this logic depends on the presence of the appropriate core Cloud module for Oracle Cloud, AWS or GCP.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All of this data is merged together into the <code>metadata</code> property for the running <a href="../api/io/micronaut/discovery/ServiceInstance.html">ServiceInstance</a>.</p>
</div>
<div class="paragraph">
<p>If you need to access the metadata for your application instance you can use the interface <a href="../api/io/micronaut/runtime/server/EmbeddedServerInstance.html">EmbeddedServerInstance</a>, and call <code>getMetadata()</code> which will get a map of all of the metadata.</p>
</div>
<div class="paragraph">
<p>If you are connecting remotely via client, the instance metadata can be referenced once you have retrieved a <a href="../api/io/micronaut/discovery/ServiceInstance.html">ServiceInstance</a> from either the <a href="../api/io/micronaut/http/client/LoadBalancer.html">LoadBalancer</a> or <a href="../api/io/micronaut/discovery/DiscoveryClient.html">DiscoveryClient</a> APIs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Netflix Ribbon client side load balancer can be configured to use the metadata to do zone aware client side load balancing. See <a href="#clientSideLoadBalancing">Client Side Load Balancing</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To obtain metadata for a service via <a href="#serviceDiscovery">Service Discovery</a> use the <a href="../api/io/micronaut/http/client/LoadBalancerResolver.html">LoadBalancerResolver</a> interface to resolve a <a href="../api/io/micronaut/http/client/LoadBalancer.html">LoadBalancer</a> and obtain a reference to a service by identifier:</p>
</div>
<div class="listingblock">
<div class="title">Obtaining Metadata for a Service instance</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">LoadBalancer loadBalancer = loadBalancerResolver.resolve("some-service");
Flowable.fromPublisher(
    loadBalancer.select()
).subscribe((instance) -&gt;
    ConvertibleValues&lt;String&gt; metaData = instance.getMetadata();
    ...
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="../api/io/micronaut/runtime/server/EmbeddedServerInstance.html">EmbeddedServerInstance</a> is available through event listeners that listen for the <a href="../api/io/micronaut/discovery/event/ServiceReadyEvent.html">ServiceReadyEvent</a>. The <a href="../api/io/micronaut/runtime/event/annotation/EventListener.html">@EventListener</a> annotation makes it easy to listen for the event inside one of your existing beans.</p>
</div>
<div class="paragraph">
<p>To obtain metadata for the locally running server use an <a href="#events">EventListener</a> for the <a href="../api/io/micronaut/discovery/event/ServiceReadyEvent.html">ServiceReadyEvent</a>:</p>
</div>
<div class="listingblock">
<div class="title">Obtaining Metadata for a Local Server</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EventListener
void onServiceStarted(ServiceReadyEvent event) {
    ServiceInstance serviceInstance = event.getSource()
    ConvertibleValues&lt;String&gt; metadata = serviceInstance.metadata
}</code></pre>
</div>
</div>
</div>
</div>

<h2 id="distributedConfiguration"><a class="anchor" href="#distributedConfiguration"></a>8.1.1 Distributed Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/cloudConfiguration/distributedConfiguration.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>As you can see, Micronaut features a robust system for externalizing and adapting configuration to the environment inspired by similar approaches found in Grails and Spring Boot.</p>
</div>
<div class="paragraph">
<p>However, what if you want two Microservices to share configuration? Micronaut comes with built in APIs for doing distributed configuration.</p>
</div>
<div class="paragraph">
<p>The <a href="../api/io/micronaut/discovery/config/ConfigurationClient.html">ConfigurationClient</a> interface has a single method called <code>getPropertySources</code> that can be implemented to read and resolve configuration from distributed sources.</p>
</div>
<div class="paragraph">
<p>The <code>getPropertySources</code> returns a <a href="http://www.reactive-streams.org/reactive-streams-1.0.3-javadoc/org/reactivestreams/Publisher.html">Publisher</a> that emits zero or many <a href="../api/io/micronaut/context/env/PropertySource.html">PropertySource</a> instances.</p>
</div>
<div class="paragraph">
<p>The default implementation is <a href="../api/io/micronaut/discovery/config/DefaultCompositeConfigurationClient.html">DefaultCompositeConfigurationClient</a> which merges all registered <code>ConfigurationClient</code> beans into a single bean.</p>
</div>
<div class="paragraph">
<p>You can either implement your own <a href="../api/io/micronaut/discovery/config/ConfigurationClient.html">ConfigurationClient</a> implementation or you can use one of the ones already built into Micronaut. The following sections cover those.</p>
</div>

<h2 id="distributedConfigurationConsul"><a class="anchor" href="#distributedConfigurationConsul"></a>8.1.2 HashiCorp Consul Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/cloudConfiguration/distributedConfigurationConsul.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="https://www.consul.io">Consul</a> is a popular Service Discovery and Distributed Configuration server provided by HashiCorp. Micronaut features a native <a href="../api/io/micronaut/discovery/consul/client/v1/ConsulClient.html">ConsulClient</a> that is built using Micronaut&#8217;s support for <a href="#clientAnnotation">Declarative HTTP Clients</a>.</p>
</div>
<div class="sect1">
<h2 id="_starting_consul">Starting Consul</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The quickest way to start using Consul is via Docker:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Starting Consul with Docker</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>docker run -p 8500:8500 consul</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can <a href="https://www.consul.io/docs/install/index.html">install and run a local Consul instance</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enabling_distributed_configuration_with_consul">Enabling Distributed Configuration with Consul</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Using the CLI</div>
<div class="paragraph">
<p>If you are creating your project using the Micronaut CLI, supply the <code>config-consul</code> feature to enable Consul&#8217;s distributed configuration in your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mn create-app my-app --features config-consul</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To enable distributed configuration, similar to Spring Boot and Grails, you need to create a <code>src/main/resources/bootstrap.yml</code> configuration file and configure Consul as well as enable the configuration client:</p>
</div>
<div class="listingblock">
<div class="title">bootstrap.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
    application:
        name: hello-world
    config-client:
        enabled: true
consul:
    client:
        defaultZone: "${CONSUL_HOST:localhost}:${CONSUL_PORT:8500}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have enabled distributed configuration you need to store the configuration you wish to share in Consul&#8217;s Key/Value store.</p>
</div>
<div class="paragraph">
<p>There are a number of different ways to do that.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_storing_configuration_as_key_value_pairs">Storing Configuration as Key/Value Pairs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One way is to store each key and value directly in Consul. In this case by default Micronaut will look for configuration in the <code>/config</code> folder of Consul.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can alter the path searched for by setting <code>consul.client.config.path</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Within the <code>/config</code> folder Micronaut will search values within the following folders in order of precedence:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Configuration Resolution Precedence</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Folder</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration shared by all applications</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/application,prod</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration shared by all applications for the <code>prod</code> <a href="../api/io/micronaut/context/env/Environment.html">Environment</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/[APPLICATION_NAME]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application specific configuration, example <code>/config/hello-world</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/[APPLICATION_NAME],prod</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application specific configuration for an active <a href="../api/io/micronaut/context/env/Environment.html">Environment</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The value of <code>APPLICATION_NAME</code> is whatever your have configured <code>micronaut.application.name</code> to be in <code>bootstrap.yml</code>.</p>
</div>
<div class="paragraph">
<p>To see this in action use the following curl command to store a property called <code>foo.bar</code> with a value of <code>myvalue</code> in the folder <code>/config/application</code>.</p>
</div>
<div class="listingblock">
<div class="title">Using curl to Write a Value</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -X PUT -d @- localhost:8500/v1/kv/config/application/foo.bar &lt;&lt;&lt; myvalue</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you now define a <code>@Value("${foo.bar}")</code> or call <code>environment.getProperty(..)</code> the value <code>myvalue</code> will be resolved from Consul.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_storing_configuration_in_yaml_json_etc">Storing Configuration in YAML, JSON etc.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some Consul users prefer storing configuration in blobs of a certain format, such as YAML. Micronaut supports this mode and supports storing configuration in either YAML, JSON or Java properties format.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="../api/io/micronaut/discovery/config/ConfigDiscoveryConfiguration.html">ConfigDiscoveryConfiguration</a> has a number of configuration options for configuring how distributed configuration is discovered.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can set the <code>consul.client.config.format</code> option to configure the format with which properties are read.</p>
</div>
<div class="paragraph">
<p>For example, to configure JSON:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">consul:
    client:
        config:
            format: JSON</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now write your configuration in JSON format to Consul:</p>
</div>
<div class="listingblock">
<div class="title">Using curl write JSON</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -X PUT  localhost:8500/v1/kv/config/application \
-d @- &lt;&lt; EOF
{ "foo": {  "bar": "myvalue" } }
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_storing_configuration_as_file_references">Storing Configuration as File References</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Another popular option is <a href="https://github.com/breser/git2consul">git2consul</a> which mirrors the contents of a Git repository to Consul&#8217;s Key/Value store.</p>
</div>
<div class="paragraph">
<p>You can setup a Git repository that contains files like <code>application.yml</code>, <code>hello-world-test.json</code> etc. and the contents of these files are cloned to Consul.</p>
</div>
<div class="paragraph">
<p>In this case each key in consul represents a file with an extension. For example <code>/config/application.yml</code> and you must configure the <code>FILE</code> format:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">consul:
    client:
        config:
            format: FILE</code></pre>
</div>
</div>
</div>
</div>

<h2 id="distributedConfigurationVault"><a class="anchor" href="#distributedConfigurationVault"></a>8.1.3 HashiCorp Vault Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/cloudConfiguration/distributedConfigurationVault.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut features support for integration with <a href="https://www.vaultproject.io/">HashiCorp Vault</a> as a distributed configuration source.</p>
</div>
<div class="paragraph">
<p>To enable support for Vault Configuration simply add the following configuration to your <code>bootstrap.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">Integrating with HashiCorp Vault</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
    application:
        name: hello-world
    config-client:
        enabled: true

vault:
    client:
        config:
            enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved directive in &lt;stdin&gt; - include::/home/runner/work/micronaut-core/micronaut-core/build/generated/configurationProperties/io.micronaut.discovery.vault.config.VaultClientConfiguration.adoc[]</p>
</div>
<div class="paragraph">
<p>Micronaut will use the configured <code>micronaut.application.name</code> to lookup property sources for the application from Vault.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Configuration Resolution Precedence</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Folder</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration shared by all applications</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/[APPLICATION_NAME]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application specific configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/application/[ENV_NAME]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration shared by all applications for an active environment name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/[APPLICATION_NAME]/[ENV_NAME]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application specific configuration for an active environment name</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See the <a href="https://www.vaultproject.io/api/secret/kv/index.html">Documentation for HashiCorp Vault</a> for more information on how to setup the server.</p>
</div>

<h2 id="distributedConfigurationSpringCloud"><a class="anchor" href="#distributedConfigurationSpringCloud"></a>8.1.4 Spring Cloud Config Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/cloudConfiguration/distributedConfigurationSpringCloud.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Since 1.1, Micronaut features a native <a href="https://spring.io/projects/spring-cloud-config">Spring Cloud Configuration</a> for those who have not switched to a dedicated more complete solution like Consul.</p>
</div>
<div class="paragraph">
<p>To enable support for Spring Cloud Configuration simply add the following configuration to your <code>bootstrap.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">Integrating with Spring Cloud Configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
    application:
        name: hello-world
    config-client:
        enabled: true
spring:
    cloud:
        config:
            enabled: true
            uri: http://localhost:8888/
            retry-attempts: 4 # optional, number of times to retry
            retry-delay: 2s # optional, delay between retries</code></pre>
</div>
</div>
<div class="paragraph">
<p>Micronaut will use the configured <code>micronaut.application.name</code> to lookup property sources for the application from Spring Cloud config server configured via <code>spring.cloud.config.uri</code>.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://spring.io/projects/spring-cloud-config#learn">Documentation for Spring Cloud Config Server</a> for more information on how to setup the server.</p>
</div>

<h2 id="distributedConfigurationAwsParameterStore"><a class="anchor" href="#distributedConfigurationAwsParameterStore"></a>8.1.5 AWS Parameter Store Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/cloudConfiguration/distributedConfigurationAwsParameterStore.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut supports configuration sharing via AWS System Manager Parameter Store. You will need the following dependencies configured:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.aws:micronaut-aws-parameter-store")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.aws&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-parameter-store&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</p>
</div>
<div class="paragraph">
<p>To enable distributed configuration a <code>src/main/resources/bootstrap.yml</code> configuration file must be created and configured to use Parameter Store:</p>
</div>
<div class="listingblock">
<div class="title">bootstrap.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
    application:
        name: hello-world
    config-client:
        enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved directive in &lt;stdin&gt; - include::/home/runner/work/micronaut-core/micronaut-core/build/generated/configurationProperties/io.micronaut.discovery.aws.parameterstore.AWSParameterStoreConfiguration.adoc[]</p>
</div>
<div class="paragraph">
<p>You can configure shared properties by going into the AWS Console &#8594; System Manager &#8594; Parameter Store</p>
</div>
<div class="paragraph">
<p>Micronaut will use a hierarchy to read the configuration values, and supports <code>String</code>, <code>StringList</code>, and <code>SecureString</code> types.</p>
</div>
<div class="paragraph">
<p>You can make environment specific configurations as well by including the environment name after an underscore <code>_</code>. For example if your <code>micronaut.application.name</code> setting is set to <code>helloworld</code> then providing configuration values under <code>helloworld_test</code> will be applied only to the <code>test</code> environment.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Configuration Resolution Precedence</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Folder</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration shared by all applications</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/[APPLICATION_NAME]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application specific configuration, example <code>/config/hello-world</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/application_prod</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration shared by all applications for the <code>prod</code> <a href="../api/io/micronaut/context/env/Environment.html">Environment</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/[APPLICATION_NAME]_prod</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application specific configuration for an active <a href="../api/io/micronaut/context/env/Environment.html">Environment</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, if the configuration name <code>/config/application_test/server.url</code> is configured in AWS Parameter Store, then any application connecting to that parameter store can retrieve the value using <code>server.url</code>. If the application has <code>micronaut.application.name</code> configured to be <code>myapp</code>, then a value with the name <code>/config/myapp_test/server.url</code> will override the value just for that application.</p>
</div>
<div class="paragraph">
<p>Each level of the tree can be composed of key=value pairs. If you want multiple key value pairs, set the type to 'StringList'.</p>
</div>
<div class="paragraph">
<p>For special secure information, like keys or passwords, use the type "SecureString". KMS will be automatically invoked when you
add and retrieve values and decrypt them with the default key store for your account. If you set the configuration to not use secure strings, they will be returned to you encrypted and you must manually decrypt them.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/micronaut-projects/micronaut-examples/aws" class="bare">https://github.com/micronaut-projects/micronaut-examples/aws</a> repository showcases a sample application using this feature.</p>
</div>

<h2 id="distributedConfigurationOracleCloudVault"><a class="anchor" href="#distributedConfigurationOracleCloudVault"></a>8.1.6 Oracle Cloud Vault Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/cloudConfiguration/distributedConfigurationOracleCloudVault.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut supports loading configuration values stored in Oracle Cloud Vaults. To use this feature, add the following dependencies:</p>
</div>
<div class="listingblock">
<div class="title">Example <code>build.gradle</code> for Oracle Cloud Vault</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">compile "io.micronaut:micronaut-discovery-client"
compile group: 'com.oracle.oci.sdk', name: 'oci-java-sdk-vault', version: '1.15.4'
compile group: 'com.oracle.oci.sdk', name: 'oci-java-sdk-secrets', version: '1.15.4'
compile group: 'com.oracle.oci.sdk', name: 'oci-java-sdk-common', version: '1.15.4'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable distributed configuration a <code>src/main/resources/bootstrap.yml</code> configuration file must be created and configured to use one or more Oracle Cloud Vaults:</p>
</div>
<div class="listingblock">
<div class="title">bootstrap.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
  application:
    name: vault-test
  config-client:
    enabled: true
oraclecloud:
  vault:
    config:
      enabled: true
    vaults:
      - ocid: ocid1.vault.oc1.phx...
        compartment-ocid: ocid1.compartment.oc1...
    use-instance-principal: false
    path-to-config: ~/.oci/config
    profile: DEFAULT
    region: US-PHOENIX-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved directive in &lt;stdin&gt; - include::/home/runner/work/micronaut-core/micronaut-core/build/generated/configurationProperties/io.micronaut.discovery.oraclecloud.vault.config.OracleCloudVaultClientConfiguration.adoc[]</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can learn more about Oracle Cloud Vault Secrets by <a href="https://blogs.oracle.com/developers/protect-your-sensitive-data-with-secrets-in-the-oracle-cloud">reading this blog post</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each configured vault will be read and all of the secrets within the vault will be retrieved and set into configuration variables with the exact same name as the secret in the Oracle Cloud Vault.</p>
</div>
<div class="paragraph">
<p>For example, if you create a secret with the name of <code>SECRET_ONE</code> in your Oracle Cloud Vault, then it will be available to use in your application like any standard configuration variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Value("${SECRET_ONE}") String secretOne</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <code>@PropertyName</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Property(name = "SECRET_ONE") String secretOne</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option is to inject your variables in to your configuration files which gives you the ability to store things like database passwords and API keys in your vault:</p>
</div>
<div class="listingblock">
<div class="title">application.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">datasources:
  default:
    password: ${DB_PASSWORD}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vault retrieved values are always <code>String</code>, but you can use <code>@ConfigurationProperties</code> on a bean in conjunction with your <code>application.yml</code> file to provide properly typed configuration variables.</p>
</div>
<div class="paragraph">
<p>So if you where to create secrets in your Oracle Cloud Vault like so:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SECRET_ONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value One</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SECRET_TWO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">value two</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SECRET_THREE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SECRET_FOUR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SECRET_FIVE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.16</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And then added the following to your <code>application.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">secrets:
  one: ${SECRET_ONE}
  two: ${SECRET_TWO}
  three: ${SECRET_THREE}
  four: ${SECRET_FOUR}
  five: ${SECRET_FIVE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could add a config bean like so:</p>
</div>
<div class="listingblock">
<div class="title">Config.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ConfigurationProperties("secrets")
public class Config {
    private String one;
    private String two;
    private boolean three;
    private int four;
    private Double five;

    /* getters/setters removed for brevity */
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could then inject and use this bean in your application with properly typed values.</p>
</div>
<div class="listingblock">
<div class="title">HelloController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Controller("/hello")
public class HelloController {

    private Config config;

    public HelloController(
            Config config
    ) {
        this.config = config;
    }

    @Get("/")
    public HttpStatus index() {
        return HttpStatus.OK;
    }

    @Get("/secret")
    public HttpResponse getSecret() {
        return HttpResponse.ok(config);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calling the <code>/hello/secret</code> endpoint would return:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "one": "Value One",
  "two": "value two",
  "three": true,
  "four": 42,
  "five": 3.16
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you need support for different configurations per environment, you can create an environment specific <code>bootstrap.yml</code> file and utilize a different vault(s) configuration per environment.
</td>
</tr>
</table>
</div>

<h2 id="serviceDiscovery"><a class="anchor" href="#serviceDiscovery"></a>8.2 Service Discovery</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/serviceDiscovery.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Service Discovery enables the ability for Microservices to find each other without necessarily knowing the physical location or IP address of associated services.</p>
</div>
<div class="paragraph">
<p>Micronaut provides integration with different tools and libraries. Check
<a href="https://micronaut-projects.github.io/micronaut-discovery-client/lastest/guide/index.html">Micronaut Service Discovery documentation</a>
for more details.</p>
</div>

<h2 id="serviceDiscoveryConsul"><a class="anchor" href="#serviceDiscoveryConsul"></a>8.2.1 Consul Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/serviceDiscovery/serviceDiscoveryConsul.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Check <a href="https://micronaut-projects.github.io/micronaut-discovery-client/lastest/guide/index.html#serviceDiscoveryConsul">Micronaut Consul documentation</a>.</p>
</div>

<h2 id="serviceDiscoveryEureka"><a class="anchor" href="#serviceDiscoveryEureka"></a>8.2.2 Eureka Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/serviceDiscovery/serviceDiscoveryEureka.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Check <a href="https://micronaut-projects.github.io/micronaut-discovery-client/lastest/guide/index.html#serviceDiscoveryEureka">Micronaut Eureka documentation</a>.</p>
</div>

<h2 id="serviceDiscoveryKubernetes"><a class="anchor" href="#serviceDiscoveryKubernetes"></a>8.2.3 Kubernetes Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/serviceDiscovery/serviceDiscoveryKubernetes.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Kubernetes is a container runtime which has a whole bunch of features including integrated Service Discovery and Distributed Configuration.</p>
</div>
<div class="paragraph">
<p>Micronaut have a first-class integration with Kubernetes. Check the <a href="https://micronaut-projects.github.io/micronaut-kubernetes/latest/guide/index.html">Micronaut Kubernetes documentation</a> for more details.</p>
</div>

<h2 id="serviceDiscoveryRoute53"><a class="anchor" href="#serviceDiscoveryRoute53"></a>8.2.4 AWS Route 53 Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/serviceDiscovery/serviceDiscoveryRoute53.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To use the <a href="https://aws.amazon.com/route53/">Route 53 Service Discovery</a>, you must meet the following criteria:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run EC2 instances of some type</p>
</li>
<li>
<p>Have a domain name hosted in Route 53</p>
</li>
<li>
<p>Have a newer version of AWS-CLI (such as 14+)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assuming you have those things, you are ready. It is not as fancy as Consul or Eureka, but other than some initial setup
with the AWS-CLI, there is no other software running to go wrong. You can even support health checks
if you add a custom health check to your service. If you would like to test if your account can create and use Service Discovery see the Integration Test section.
More information can be found at <a href="https://docs.aws.amazon.com/Route53/latest/APIReference/overview-service-discovery.html" class="bare">https://docs.aws.amazon.com/Route53/latest/APIReference/overview-service-discovery.html</a>.</p>
</div>
<div class="paragraph">
<p>Here are the steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use AWS-CLI to create a namespace. You can make either a public or private one depending on what IPs or subnets
you are using</p>
</li>
<li>
<p>Create a service with DNS Records with AWS-CLI command</p>
</li>
<li>
<p>Add health checks or custom health checks (optional)</p>
</li>
<li>
<p>Add Service ID to your application configuration file like so:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Sample application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">aws:
    route53:
        registration
            enabled: true
            aws-service-id: srv-978fs98fsdf
            namespace: micronaut.io
micronaut:
    application:
        name: something</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure you have the following dependencies included in your build file:</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut.aws:micronaut-aws-route53")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut.aws&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-aws-route53&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the client side, you will need the same dependencies and less configuration options:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Sample application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">aws:
    route53:
        discovery:
            client:
                enabled: true
                aws-service-id: srv-978fs98fsdf
                namespace-id: micronaut.io</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then use the <a href="../api/io/micronaut/discovery/DiscoveryClient.html">DiscoveryClient</a> API to find other services registered via Route 53. For example:</p>
</div>
<div class="listingblock">
<div class="title">Sample code for client</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">DiscoveryClient discoveryClient = embeddedServer.applicationContext.getBean(DiscoveryClient);
List&lt;String&gt; serviceIds = Flowable.fromPublisher(discoveryClient.getServiceIds()).blockingFirst();
List&lt;ServiceInstance&gt; instances = Flowable.fromPublisher(discoveryClient.getInstances(serviceIds.get(0))).blockingFirst();</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_namespace">Creating the Namespace</h4>
<div class="paragraph">
<p>Namespaces are similar to a regular Route53 hosted zone, and they appear in the Route53 console but the console doesn&#8217;t support
 modifying them. You must use the AWS-CLI at this time for any Service Discovery functionality.</p>
</div>
<div class="paragraph">
<p>First decide if you are creating a public facing namespace or a private one, as the commands are different:</p>
</div>
<div class="listingblock">
<div class="title">Creating Namespace</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ aws servicediscovery create-public-dns-namespace --name micronaut.io --create-request-id create-1522767790 --description adescrptionhere

or

$ aws servicediscovery create-private-dns-namespace --name micronaut.internal.io --create-request-id create-1522767790 --description adescrptionhere --vpc yourvpcID</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run this you will get an operation ID. You can check the status with the <code>get-operation</code> CLI command:</p>
</div>
<div class="listingblock">
<div class="title">Get Operation Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ aws servicediscovery get-operation --operation-id asdffasdfsda</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use this command to get the status of any call you make that returns an operation id.</p>
</div>
<div class="paragraph">
<p>The result of the command will tell you the ID of the namespace. Write that down, you&#8217;ll need it for the next steps. If you get an error it will say what the error was.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_service_dns_records">Creating the Service &amp; DNS Records</h4>
<div class="paragraph">
<p>The next step is creating the Service and DNS records.</p>
</div>
<div class="listingblock">
<div class="title">Create Service</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ aws create-service --name yourservicename --create-request-id somenumber --description someservicedescrption --dns-config NamespaceId=yournamespaceid,RoutingPolicy=WEIGHTED,DnsRecords=[{Type=A,TTL=1000},{Type=A,TTL=1000}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>DnsRecord</code> type can be <code>A</code>(ipv4),<code>AAAA</code>(ipv6),<code>SRV</code>, or <code>CNAME</code>. <code>RoutingPolicy</code> can be <code>WEIGHTED</code> or <code>MULTIVALUE</code>. Keep in mind <code>CNAME</code> must use weighted routing type, <code>SRV</code> must have a valid port configured.</p>
</div>
<div class="paragraph">
<p>If you want to add a health check, you can use the following syntax on the CLI:</p>
</div>
<div class="listingblock">
<div class="title">Specifying a Health Check</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Type=string,ResourcePath=string,FailureThreshold=integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Type can be 'HTTP','HTTPS', or 'TCP'. You can only use a standard health check on a public namespace. See Custom Health Checks for private namespaces. Resource path should be a url that returns 200 OK if it&#8217;s healthy.</p>
</div>
<div class="paragraph">
<p>For a custom health check, you only need to specify <code>--health-check-custom-config FailureThreshold=integer</code> which will work on private namespaces as well.</p>
</div>
<div class="paragraph">
<p>This is also good because Micronaut will send out pulsation commands to let AWS know the instance is still healthy.</p>
</div>
<div class="paragraph">
<p>For more help run 'aws discoveryservice create-service help'.</p>
</div>
<div class="paragraph">
<p>You will get a service ID and an ARN back from this command if successful. Write that down, it&#8217;s going to go into the Micronaut configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_the_configuration_in_micronaut">Setting up the configuration in Micronaut</h4>

</div>
<div class="sect3">
<h4 id="_auto_naming_registration">Auto Naming Registration</h4>
<div class="paragraph">
<p>You will need to add the configuration to make your applications register with Route 53 Auto-discovery:</p>
</div>
<div class="listingblock">
<div class="title">Registration Properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">aws:
    route53:
        registration:
            enabled: true
            aws-service-id=&lt;enter the service id you got after creation on aws cli&gt;
        discovery:
            namespace-id=&lt;enter the namespace id you got after creating the namespace&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discovery_client_configuration">Discovery Client Configuration</h4>
<div class="listingblock">
<div class="title">Discovery Properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">aws:
    route53:
        discovery:
            client
                enabled: true
                aws-service-id: &lt;enter the service id you got after creation on aws cli&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also call the following methods by getting the bean "Route53AutoNamingClient":</p>
</div>
<div class="listingblock">
<div class="title">Discovery Methods</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// if serviceId is null it will use property "aws.route53.discovery.client.awsServiceId"
Publisher&lt;List&lt;ServiceInstance&gt;&gt; getInstances(String serviceId)
// reads property "aws.route53.discovery.namespaceId"
Publisher&lt;List&lt;String&gt;&gt; getServiceIds()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_integration_tests">Integration Tests</h4>
<div class="paragraph">
<p>If you set the environment variable AWS_SUBNET_ID and have credentials configured in your home directory that are valid (in <code>~/.aws/credentials</code>)
you can run the integration tests. You will still need a domain hosted on route53 as well. This test will create a t2.nano instance, a namespace, service, and register that instance to service discovery.
When the test completes it will remove/terminate all resources it spun up.</p>
</div>
</div>

<h2 id="serviceDiscoveryManual"><a class="anchor" href="#serviceDiscoveryManual"></a>8.2.5 Manual Service Discovery Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/serviceDiscovery/serviceDiscoveryManual.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>If you do not wish to involve a service discovery server like Consul or you are interacting with a third-party service that cannot register with Consul you can instead manually configure services that are available via Service discovery.</p>
</div>
<div class="paragraph">
<p>To do this you should use the <code>micronaut.http.services</code> setting. The following is an example configuration:</p>
</div>
<div class="listingblock">
<div class="title">Manually configuring services</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
    http:
        services:
            foo:
                urls:
                    - http://foo1
                    - http://foo2</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then inject a client with <code>@Client("foo")</code> and it will use the above configuration to load balance between the two configured servers.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can override this configuration in production by specifying an environment variable such as <code>MICRONAUT_HTTP_SERVICES_FOO_URLS=http://prod1,http://prod2</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that by default no health checking will happen to assert that the referenced services are operational. You can alter that by enabling health checking and optionally specifying a health check path (the default is <code>/health</code>):</p>
</div>
<div class="listingblock">
<div class="title">Enabling Health Checking</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">micronaut:
    http:
        services:
            foo:
                ...
                health-check: true <i class="conum" data-value="1"></i><b>(1)</b>
                health-check-interval: 15s <i class="conum" data-value="2"></i><b>(2)</b>
                health-check-uri: /health <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Whether to health check the service</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The interval to wait between checks</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The URI to send the health check request to</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Micronaut will start a background thread to check the health status of the service and if any of the configured services respond with an error code, they will be removed from the list of available services.</p>
</div>

<h2 id="clientSideLoadBalancing"><a class="anchor" href="#clientSideLoadBalancing"></a>8.3 Client Side Load Balancing</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/clientSideLoadBalancing.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>When <a href="#serviceDiscovery">discovering services</a> from Consul, Eureka or other Service Discovery servers the <a href="../api/io/micronaut/discovery/DiscoveryClient.html">DiscoveryClient</a> will emit a list of available <a href="../api/io/micronaut/discovery/ServiceInstance.html">ServiceInstance</a>.</p>
</div>
<div class="paragraph">
<p>Micronaut by default will automatically perform Round Robin client-side load balancing using the servers in this list. This combined with <a href="#retry">Retry Advice</a> adds extra resiliency to your Microservice infrastructure.</p>
</div>
<div class="paragraph">
<p>The load balancing itself is handled by the <a href="../api/io/micronaut/http/client/LoadBalancer.html">LoadBalancer</a> interface which defines a  <a href="../api/io/micronaut/http/client/LoadBalancer.html#select--">LoadBalancer.select()</a> method that returns a <code>Publisher</code> that emits a <a href="../api/io/micronaut/discovery/ServiceInstance.html">ServiceInstance</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="http://www.reactive-streams.org/reactive-streams-1.0.3-javadoc/org/reactivestreams/Publisher.html">Publisher</a> is returned because the process for selecting a <a href="../api/io/micronaut/discovery/ServiceInstance.html">ServiceInstance</a> may result in a network operation depending on the <a href="#serviceDiscovery">Service Discovery</a> strategy employed.</p>
</div>
<div class="paragraph">
<p>The default implementation of the <a href="../api/io/micronaut/http/client/LoadBalancer.html">LoadBalancer</a> interface is <a href="../api/io/micronaut/http/client/loadbalance/DiscoveryClientRoundRobinLoadBalancer.html">DiscoveryClientRoundRobinLoadBalancer</a>. You can replace this strategy for another implementation if you wish to customize how client side load balancing is handled in Micronaut since there are many different ways you may wish to optimize load balancing.</p>
</div>
<div class="paragraph">
<p>For example, you may wish to load balance between services in a particular zone or you may wish to load balance between servers that have the best overall response time.</p>
</div>
<div class="paragraph">
<p>To replace the <a href="../api/io/micronaut/http/client/LoadBalancer.html">LoadBalancer</a> used you should define a bean that <a href="#replaces">replaces</a> the <a href="../api/io/micronaut/http/client/loadbalance/DiscoveryClientLoadBalancerFactory.html">DiscoveryClientLoadBalancerFactory</a>.</p>
</div>
<div class="paragraph">
<p>In fact that is exactly what the Netflix Ribbon support does, described in the next section.</p>
</div>

<h2 id="netflixRibbon"><a class="anchor" href="#netflixRibbon"></a>8.3.1 Netflix Ribbon Support</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/clientSideLoadBalancing/netflixRibbon.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Using the CLI</div>
<div class="paragraph">
<p>If you are creating your project using the Micronaut CLI, supply the <code>netflix-ribbon</code> feature to configure Netflix Ribbon in your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mn create-app my-app --features netflix-ribbon</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/Netflix/ribbon">Netflix Ribbon</a> is a inter-process communication library used at Netflix that has support for customizable load balancing strategies.</p>
</div>
<div class="paragraph">
<p>If you need more flexibility in how your application performs client-side load balancing then you may wish use Micronaut&#8217;s Netflix Ribbon support.</p>
</div>
<div class="paragraph">
<p>To add Ribbon support to your application add the <code>netflix-ribbon</code> configuration to <code>build.gradle</code> or <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">compile "io.micronaut.netflix:micronaut-netflix-ribbon"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="../api/io/micronaut/http/client/LoadBalancer.html">LoadBalancer</a> implementations will now be <a href="../api/io/micronaut/configuration/ribbon/RibbonLoadBalancer.html">RibbonLoadBalancer</a> instances.</p>
</div>
<div class="paragraph">
<p>Ribbon&#8217;s <a href="http://netflix.github.io/ribbon/ribbon-core-javadoc/com/netflix/client/config/CommonClientConfigKey.html">Configuration options</a> can be set using the <code>ribbon</code> namespace in configuration. For example in <code>application.yml</code>:</p>
</div>
<div class="listingblock">
<div class="title">Configuring Ribbon</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">ribbon:
    VipAddress: test
    ServerListRefreshInterval: 2000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each discovered client can also be configured under <code>ribbon.clients</code>. For example given a <code>@Client(id = "hello-world")</code> you can configure Ribbon settings with:</p>
</div>
<div class="listingblock">
<div class="title">Per Client Ribbon Settings</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">ribbon:
    clients:
        hello-world:
            VipAddress: test
            ServerListRefreshInterval: 2000</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default Micronaut registers a <a href="../api/io/micronaut/configuration/ribbon/DiscoveryClientServerList.html">DiscoveryClientServerList</a> for each client that integrates Ribbon with Micronaut&#8217;s <a href="../api/io/micronaut/discovery/DiscoveryClient.html">DiscoveryClient</a>.</p>
</div>

<h2 id="distributedTracing"><a class="anchor" href="#distributedTracing"></a>8.4 Distributed Tracing</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/distributedTracing.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>When operating Microservices in production it can be challenging to troubleshoot interactions between Microservices in a distributed architecture.</p>
</div>
<div class="paragraph">
<p>To solve this problem a way to visualize interactions between Microservices in a distributed manner can be critical. Currently, there are various distributed tracing solutions, the most popular of which are <a href="https://zipkin.io">Zipkin</a> and <a href="https://www.jaegertracing.io/">Jaeger</a> both of which provide different levels of support for the <a href="http://opentracing.io">Open Tracing</a> API.</p>
</div>
<div class="paragraph">
<p>Micronaut features integration with both Zipkin and Jaeger (via the Open Tracing API).</p>
</div>
<div class="paragraph">
<p>To enable tracing you should add the <code>tracing</code> module to your <code>build.gradle</code> or <code>pom.xml</code> file:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="title"></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="gradle">implementation(<span class="hljs-string">"io.micronaut:micronaut-tracing")</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;dependency&gt;
    &lt;groupId&gt;io.micronaut&lt;/groupId&gt;
    &lt;artifactId&gt;micronaut-tracing&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</p>
</div>
<div class="sect1">
<h2 id="_tracing_annotations">Tracing Annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="../api/io/micronaut/tracing/annotation/package-summary.html">io.micronaut.tracing.annotation</a> package contains annotations that can be declared on methods to create new spans or continue existing spans.</p>
</div>
<div class="paragraph">
<p>The available annotations are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="../api/io/micronaut/tracing/annotation/NewSpan.html">@NewSpan</a> annotation will create a new span, wrapping the method call or reactive type.</p>
</li>
<li>
<p>The <a href="../api/io/micronaut/tracing/annotation/ContinueSpan.html">@ContinueSpan</a> annotation will continue an existing span, wrapping the method call or reactive type.</p>
</li>
<li>
<p>The <a href="../api/io/micronaut/tracing/annotation/SpanTag.html">@SpanTag</a> annotation can be used on method arguments to include the value of each argument within a Span&#8217;s tags. When you use <code>@SpanTag</code> on a method argument, you need either to annotate the method with <code>@NewSpan</code> or <code>@ContinueSpan</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following snippet presents an example of using the annotations:</p>
</div>
<div class="listingblock">
<div class="title">Using Trace Annotations</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Singleton
class HelloService {

    @NewSpan("hello-world") <i class="conum" data-value="1"></i><b>(1)</b>
    public String hello(@SpanTag("person.name") String name) { <i class="conum" data-value="2"></i><b>(2)</b>
        return greet("Hello " + name);
    }

    @ContinueSpan <i class="conum" data-value="3"></i><b>(3)</b>
    public String greet(@SpanTag("hello.greeting") String greet) {
        return greet;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="../api/io/micronaut/tracing/annotation/NewSpan.html">@NewSpan</a> annotation is used to start a new span</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can use <a href="../api/io/micronaut/tracing/annotation/SpanTag.html">@SpanTag</a> to include arguments of methods as tags for the span</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="../api/io/micronaut/tracing/annotation/ContinueSpan.html">@ContinueSpan</a> annotation can be used to continue as existing span and incorporate additional tags using <code>@SpanTag</code></td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_tracing_instrumentation">Tracing Instrumentation</h3>
<div class="paragraph">
<p>In addition to explicit tracing tags, Micronaut includes a number of instrumentations to ensure that the Span context is propagated between threads and across Microservice boundaries.</p>
</div>
<div class="paragraph">
<p>These instrumentations are found in the <a href="../api/io/micronaut/tracing/instrument/package-summary.html">io.micronaut.tracing.instrument</a> package and include HTTP <a href="#clientFilter">Client Filters</a> and <a href="#filters">Server Filters</a> to propagate the necessary headers via HTTP.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tracing_beans">Tracing Beans</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If the Tracing annotations and existing instrumentations are not enough, Micronaut&#8217;s tracing integration registers a <code>io.opentracing.Tracer</code> bean that can be injected into any class and exposes the Open Tracing API.</p>
</div>
<div class="paragraph">
<p>Depending on the implementation you choose there are also additional beans. For example for Zipkin <code>brave.Tracing</code> and <code>brave.SpanCustomizer</code> beans are available too.</p>
</div>
</div>
</div>

<h2 id="zipkin"><a class="anchor" href="#zipkin"></a>8.4.1 Tracing with Zipkin</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/distributedTracing/zipkin.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="https://zipkin.io">Zipkin</a> is a distributed tracing system. It helps gather timing data needed to troubleshoot latency problems in microservice architectures. It manages both the collection and lookup of this data.</p>
</div>
<div class="sect1">
<h2 id="_running_zipkin">Running Zipkin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The quickest way to get up and started with Zipkin is with Docker:</p>
</div>
<div class="listingblock">
<div class="title">Running Zipkin with Docker</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ docker run -d -p 9411:9411 openzipkin/zipkin</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then open a browser tab to the location <code><a href="http://localhost:9411" class="bare">http://localhost:9411</a></code> to view traces.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sending_traces_to_zipkin">Sending Traces to Zipkin</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Using the CLI</div>
<div class="paragraph">
<p>If you are creating your project using the Micronaut CLI, supply the <code>tracing-zipkin</code> feature to include Zipkin tracing in your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mn create-app my-app --features tracing-zipkin</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To send tracing spans to Zipkin the minimal configuration requires you add the following dependencies to <code>build.gradle</code> or <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="title">Adding Zipkin Dependencies</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">runtime 'io.zipkin.brave:brave-instrumentation-http'
runtime 'io.zipkin.reporter2:zipkin-reporter'
compile 'io.opentracing.brave:brave-opentracing'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you need to enable ZipKin tracing in your configuration (potentially only your production configuration):</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">tracing:
    zipkin:
        enabled: true</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Or alternatively if you have the Micronaut CLI installed you can configure Zipkin when creating your service with: <code>mn create-app hello-world --features tracing-zipkin</code>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customizing_the_zipkin_sender">Customizing the Zipkin Sender</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to send spans you need to configure a Zipkin sender. You can configure a <a href="../api/io/micronaut/tracing/brave/sender/HttpClientSender.html">HttpClientSender</a> that sends Spans asynchronously using Micronaut&#8217;s native HTTP client using the <code>tracing.zipkin.http.url</code> setting:</p>
</div>
<div class="listingblock">
<div class="title">Configuring Multiple Zipkin Servers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">tracing:
    zipkin:
        enabled: true
        http:
            url: http://localhost:9411</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is unlikely that sending spans to localhost will be suitable for production deployment so you generally will want to configure the location of one or many Zipkin servers for production:</p>
</div>
<div class="listingblock">
<div class="title">Configuring Multiple Zipkin Servers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">tracing:
    zipkin:
        enabled: true
        http:
            urls:
                - http://foo:9411
                - http://bar:9411</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In production, setting <code>TRACING_ZIPKIN_HTTP_URLS</code> environment variable with a comma separated list of URLs will also work.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively if you wish to use a different <code>zipkin2.reporter.Sender</code> implementation, you can simply define a bean that is of type <code>zipkin2.reporter.Sender</code> and it will be picked up.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_zipkin_configuration">Zipkin Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many configuration options available for the Brave client that sends Spans to Zipkin and they are generally exposed via the <a href="../api/io/micronaut/tracing/brave/BraveTracerConfiguration.html">BraveTracerConfiguration</a> class. You can refer to the javadoc for all the available options.</p>
</div>
<div class="paragraph">
<p>Below is an example of customizing Zipkin configuration:</p>
</div>
<div class="listingblock">
<div class="title">Customizing Zipkin Configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">tracing:
    zipkin:
        enabled: true
        traceId128Bit: true
        sampler:
            probability: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also optionally dependency inject common configuration classes into <a href="../api/io/micronaut/tracing/brave/BraveTracerConfiguration.html">BraveTracerConfiguration</a> such as <code>brave.sampler.Sampler</code> just by defining them as beans. See the API for <a href="../api/io/micronaut/tracing/brave/BraveTracerConfiguration.html">BraveTracerConfiguration</a> for available injection points.</p>
</div>
</div>
</div>

<h2 id="jaeger"><a class="anchor" href="#jaeger"></a>8.4.2 Tracing with Jaeger</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/cloud/distributedTracing/jaeger.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="https://www.jaegertracing.io">Jaeger</a> is another distributed tracing system developed at Uber that is more or less the reference implementation for <a href="http://opentracing.io">Open Tracing</a>.</p>
</div>
<div class="sect1">
<h2 id="_running_jaeger">Running Jaeger</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The easiest way to get started with Jaeger is to run Jaeger via Docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ docker run -d \
  -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 \
  -p 5775:5775/udp \
  -p 6831:6831/udp \
  -p 6832:6832/udp \
  -p 5778:5778 \
  -p 16686:16686 \
  -p 14268:14268 \
  -p 9411:9411 \
  jaegertracing/all-in-one:1.6</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then navigate to <code><a href="http://localhost:16686" class="bare">http://localhost:16686</a></code> to access the Jaeger UI.</p>
</div>
<div class="paragraph">
<p>See <a href="https://www.jaegertracing.io/docs/getting-started/">Getting Started with Jaeger</a> for more information.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sending_traces_to_jaeger">Sending Traces to Jaeger</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Using the CLI</div>
<div class="paragraph">
<p>If you are creating your project using the Micronaut CLI, supply the <code>tracing-jaeger</code> feature to include Jaeger tracing in your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mn create-app my-app --features tracing-jaeger</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To send tracing spans to Jaeger the minimal configuration requires you add the following dependencies to <code>build.gradle</code> or <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="title">Adding Jaeger Dependencies</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">compile 'io.jaegertracing:jaeger-thrift:0.31.0'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you need to enable Jaeger tracing in your configuration (potentially only your production configuration):</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">tracing:
    jaeger:
        enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default Jaeger will be configured to send traces to a locally running Jaeger agent.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Or alternatively if you have the Micronaut CLI installed you can configure Jaeger when creating your service with: <code>mn create-app hello-world --features tracing-jaeger</code>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jaeger_configuration">Jaeger Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many configuration options available for the Jaeger client that sends Spans to Jaeger and they are generally exposed via the <a href="../api/io/micronaut/tracing/jaeger/JaegerConfiguration.html">JaegerConfiguration</a> class. You can refer to the javadoc for all the available options.</p>
</div>
<div class="paragraph">
<p>Below is an example of customizing JaegerConfiguration configuration:</p>
</div>
<div class="listingblock">
<div class="title">Customizing Jaeger Configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">tracing:
    jaeger:
        enabled: true
        sampler:
            probability: 0.5
        sender:
            agentHost: foo
            agentPort: 5775
        reporter:
            flushInterval: 2000
            maxQueueSize: 200</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also optionally dependency inject common configuration classes into <a href="../api/io/micronaut/tracing/jaeger/JaegerConfiguration.html">JaegerConfiguration</a> such as <code>io.jaegertracing.Configuration.SamplerConfiguration</code> just by defining them as beans. See the API for <a href="../api/io/micronaut/tracing/jaeger/JaegerConfiguration.html">JaegerConfiguration</a> for available injection points.</p>
</div>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/httpClient.html">&lt;&lt; <strong>7</strong><span>The HTTP Client</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/serverlessFunctions.html"><strong>9</strong><span>Serverless Functions</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="https://docs.micronaut.io/docsassets/js/docs.js"></script>

</body>
</html>
