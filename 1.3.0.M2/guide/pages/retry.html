<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>5.6 Retry Advice 1.3.0.M2</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="https://docs.micronaut.io/docsassets/css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="https://docs.micronaut.io/docsassets/css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/quickStart.html"><strong>2</strong><span>Quick Start</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/ioc.html"><strong>3</strong><span>Inversion of Control</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/config.html"><strong>4</strong><span>Application Configuration</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/aop.html"><strong>5</strong><span>Aspect Oriented Programming</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/httpServer.html"><strong>6</strong><span>The HTTP Server</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/httpClient.html"><strong>7</strong><span>The HTTP Client</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/cloud.html"><strong>8</strong><span>Cloud Native Features</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/serverlessFunctions.html"><strong>9</strong><span>Serverless Functions</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/messaging.html"><strong>10</strong><span>Message-Driven Microservices</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/commandLineApps.html"><strong>11</strong><span>Standalone Command Line Applications</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/configurations.html"><strong>12</strong><span>Configurations</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/languageSupport.html"><strong>13</strong><span>Language Support</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/management.html"><strong>14</strong><span>Management &amp; Monitoring</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/security.html"><strong>15</strong><span>Security</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/multitenancy.html"><strong>16</strong><span>Multi-Tenancy</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/cli.html"><strong>17</strong><span>Micronaut CLI</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/appendix.html"><strong>18</strong><span>Appendices</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/config.html">&lt;&lt; <strong>4</strong><span>Application Configuration</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/httpServer.html"><strong>6</strong><span>The HTTP Server</span> >></a></div>
                


                <div class="project">
                    <h1>5.6 Retry Advice</h1>

                    <p><strong>Version:</strong> 1.3.0.M2</p>
                </div>

                

                
<h2 id="retry"><a class="anchor" href="#retry"></a>5.6 Retry Advice</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/aop/retry.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In distributed systems and Microservice environments, failure is something you have to plan for and it is pretty common to want to attempt to retry an operation if it fails. If first you don&#8217;t succeed try again!</p>
</div>
<div class="paragraph">
<p>With this in mind Micronaut comes with a <a href="../api/io/micronaut/retry/annotation/Retryable.html">Retryable</a> annotation out of the box that is integrated into the container.</p>
</div>
<div class="sect1">
<h2 id="_simple_retry"><a class="anchor" href="#_simple_retry"></a>Simple Retry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simplest form of retry is just to add the <code>@Retryable</code> annotation to any type or method. The default behaviour of <code>@Retryable</code> is to retry 3 times with a delay of 1 second between each retry.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Simple Retry Example</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @Retryable
    public List&lt;Book&gt; listBooks() {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Simple Retry Example</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    @Retryable
    List&lt;Book&gt; listBooks() {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Simple Retry Example</div>
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">    @Retryable
    open fun listBooks(): List&lt;Book&gt; {
        // ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the above example if the <code>listBooks()</code> method throws an exception it will be retried until the maximum number of attempts is reached.</p>
</div>
<div class="paragraph">
<p>The <code>multiplier</code> value of the <code>@Retryable</code> annotation can be used to configure a multiplier used to calculate the delay between retries, thus allowing exponential retry support.</p>
</div>
<div class="paragraph">
<p>Note also that the <code>@Retryable</code> annotation can be applied on interfaces and the behaviour will be inherited through annotation metadata. The implication of this is that <code>@Retryable</code> can be used in combination with <a href="#introductionAdvice">Introduction Advice</a> such as the HTTP <a href="../api/io/micronaut/http/client/annotation/Client.html">Client</a> annotation.</p>
</div>
<div class="paragraph">
<p>To customize retry behaviour you can set the <code>attempts</code> and <code>delay</code> members, For example to configure 5 attempts with a 2 second delay:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Setting Retry Attempts</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @Retryable( attempts = "5",
                delay = "2s" )
    public Book findBook(String title) {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Setting Retry Attempts</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    @Retryable( attempts = "5",
                delay = "2s" )
    Book findBook(String title) {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Setting Retry Attempts</div>
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">    @Retryable(attempts = "5", delay = "2s")
    open fun findBook(title: String): Book {
        // ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how both <code>attempts</code> and <code>delay</code> are defined as strings. This is to support configurability through annotation metadata. For example you can allow the retry policy to be configured using property placeholder resolution:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Setting Retry via Configuration</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @Retryable( attempts = "${book.retry.attempts:3}",
                delay = "${book.retry.delay:1s}" )
    public Book getBook(String title) {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Setting Retry via Configuration</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    @Retryable( attempts = "\${book.retry.attempts:3}",
            delay = "\${book.retry.delay:1s}")
    Book getBook(String title) {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Setting Retry via Configuration</div>
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">    @Retryable(attempts = "\${book.retry.attempts:3}", delay = "\${book.retry.delay:1s}")
    open fun getBook(title: String): Book {
        // ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the above in place if <code>book.retry.attempts</code> is specified in configuration it wil be bound the value of the <code>attempts</code> member of the <code>@Retryable</code> annotation via annotation metadata.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reactive_retry"><a class="anchor" href="#_reactive_retry"></a>Reactive Retry</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>@Retryable</code> advice can also be applied to methods that return reactive types, such as an RxJava <code>Flowable</code>. For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Applying Retry Policy to Reactive Types</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @Retryable
    public Flowable&lt;Book&gt; streamBooks() {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Applying Retry Policy to Reactive Types</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    @Retryable
    Flowable&lt;Book&gt; streamBooks() {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Applying Retry Policy to Reactive Types</div>
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">    @Retryable
    open fun streamBooks(): Flowable&lt;Book&gt; {
        // ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case <code>@Retryable</code> advice will apply the retry policy to the reactive type.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_circuit_breaker"><a class="anchor" href="#_circuit_breaker"></a>Circuit Breaker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a Microservice environment retry is useful, but in some cases excessive retries can overwhelm the system as clients repeatedly re-attempt failing operations.</p>
</div>
<div class="paragraph">
<p>The <a href="https://en.wikipedia.org/wiki/Circuit_breaker_design_pattern">Circuit Breaker</a> pattern is designed to resolve this issue by essentially allowing a certain number of failing requests and then opening a circuit that remains open for a period before allowing any additional retry attempts.</p>
</div>
<div class="paragraph">
<p>The <a href="../api/io/micronaut/retry/annotation/CircuitBreaker.html">CircuitBreaker</a> annotation is a variation of the <code>@Retryable</code> annotation that supports a <code>reset</code> member that indicates how long the circuit should remain open before it is reset (the default is 20 seconds).</p>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Applying CircuitBreaker Advice</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @CircuitBreaker(reset = "30s")
    public List&lt;Book&gt; findBooks() {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Applying CircuitBreaker Advice</div>
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    @CircuitBreaker(reset = "30s")
    List&lt;Book&gt; findBooks() {
        // ...</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="title">Applying CircuitBreaker Advice</div>
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">    @CircuitBreaker(reset = "30s")
    open fun findBooks(): List&lt;Book&gt; {
        // ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will retry to <code>findBooks</code> method 3 times and then open the circuit for 30 seconds, rethrowing the original exception and preventing potential downstream traffic such as HTTP requests and I/O operations flooding the system.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bean_creation_retry"><a class="anchor" href="#_bean_creation_retry"></a>Bean Creation Retry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As mentioned previously, <code>@Retryable</code> advice is integrated right at the container level. This is useful as it is common problem in Microservices and environments like Docker where there may be a delay in services becoming available.</p>
</div>
<div class="paragraph">
<p>The following snippet is taken from the Neo4j driver support and demonstrates how bean creation can be wrapped in retry support:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Factory <i class="conum" data-value="1"></i><b>(1)</b>
public class Neo4jDriverFactory {
    ...
    @Retryable(ServiceUnavailableException.class) <i class="conum" data-value="2"></i><b>(2)</b>
    @Bean(preDestroy = "close")
    public Driver buildDriver() {
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A factory bean is created that defines methods that create beans</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>@Retryable</code> annotation is used to catch <code>ServiceUnavailableException</code> and retry creating the driver before failing startup.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_retry_events"><a class="anchor" href="#_retry_events"></a>Retry Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can register <a href="../api/io/micronaut/retry/event/RetryEventListener.html">RetryEventListener</a> instances as beans in order to listen for <a href="../api/io/micronaut/retry/event/RetryEvent.html">RetryEvent</a> events that are published every time an operation is retried.</p>
</div>
<div class="paragraph">
<p>In addition, you can register event listeners for <a href="../api/io/micronaut/retry/event/CircuitOpenEvent.html">CircuitOpenEvent</a>, when a circuit breaker circuit is opened, or <a href="../api/io/micronaut/retry/event/CircuitClosedEvent.html">CircuitClosedEvent</a> for when a circuit is closed.</p>
</div>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/config.html">&lt;&lt; <strong>4</strong><span>Application Configuration</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/httpServer.html"><strong>6</strong><span>The HTTP Server</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="https://docs.micronaut.io/docsassets/js/docs.js"></script>

</body>
</html>
