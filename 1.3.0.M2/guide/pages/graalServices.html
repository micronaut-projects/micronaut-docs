<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>13.4.1 Microservices as GraalVM native images 1.3.0.M2</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="https://docs.micronaut.io/docsassets/css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="https://docs.micronaut.io/docsassets/css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/quickStart.html"><strong>2</strong><span>Quick Start</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/ioc.html"><strong>3</strong><span>Inversion of Control</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/config.html"><strong>4</strong><span>Application Configuration</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/aop.html"><strong>5</strong><span>Aspect Oriented Programming</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/httpServer.html"><strong>6</strong><span>The HTTP Server</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/httpClient.html"><strong>7</strong><span>The HTTP Client</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/cloud.html"><strong>8</strong><span>Cloud Native Features</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/serverlessFunctions.html"><strong>9</strong><span>Serverless Functions</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/messaging.html"><strong>10</strong><span>Message-Driven Microservices</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/commandLineApps.html"><strong>11</strong><span>Standalone Command Line Applications</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/configurations.html"><strong>12</strong><span>Configurations</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/languageSupport.html"><strong>13</strong><span>Language Support</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/management.html"><strong>14</strong><span>Management &amp; Monitoring</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/security.html"><strong>15</strong><span>Security</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/multitenancy.html"><strong>16</strong><span>Multi-Tenancy</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/cli.html"><strong>17</strong><span>Micronaut CLI</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/appendix.html"><strong>18</strong><span>Appendices</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/configurations.html">&lt;&lt; <strong>12</strong><span>Configurations</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/management.html"><strong>14</strong><span>Management &amp; Monitoring</span> >></a></div>
                


                <div class="project">
                    <h1>13.4.1 Microservices as GraalVM native images</h1>

                    <p><strong>Version:</strong> 1.3.0.M2</p>
                </div>

                

                
<h2 id="graalServices"><a class="anchor" href="#graalServices"></a>13.4.1 Microservices as GraalVM native images</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/languageSupport/graal/graalServices.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect2">
<h3 id="_getting_started_with_micronaut_and_graal"><a class="anchor" href="#_getting_started_with_micronaut_and_graal"></a>Getting Started with Micronaut and Graal</h3>
<div class="paragraph">
<p>To get started creating a Microservice that can be compiled into a native image, use the <code>graal-native-image</code> feature when creating the application with the CLI:</p>
</div>
<div class="listingblock">
<div class="title">Creating a Graal Native Microservice</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ mn create-app hello-world --features graal-native-image</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For Kotlin use <code>graal-native-image-kotlin</code> feature.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>graal-native-image</code> feature adds three important items:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>svm</code> and <code>graal</code> dependencies to your <code>build.gradle</code> (or <code>pom.xml</code> if <code>--build maven</code> is used).</p>
</li>
<li>
<p>A <code>Dockerfile</code> which can be used to construct the native image using Docker and a script <code>docker-build.sh</code> to run it.</p>
</li>
<li>
<p>A <code>native-image.properties</code> configuration file <code>src/main/resources/META-INF/native-image</code> to simplify building the image.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>native-image.properties</code> file that is generated looks something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">Args = -H:IncludeResources=logback.xml|application.yml \ <i class="conum" data-value="1"></i><b>(1)</b>
       -H:Name=example \ <i class="conum" data-value="2"></i><b>(2)</b>
       -H:Class=example.Application <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>-H:IncludeResources</code> argument allows you to tweak which static resources to include.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>-H:Name</code> argument specifies the name of the native image that will be generated.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>-H:Class</code> argument specifies the entry point of your application (the class that defines a <code>static void main</code> method.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_building_a_native_image_using_docker"><a class="anchor" href="#_building_a_native_image_using_docker"></a>Building a Native Image Using Docker</h4>
<div class="paragraph">
<p>To build your native image using Docker simply run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./gradlew assemble # or ./mvnw package if using Maven
$ docker build . -t hello-world
$ docker run -p 8080:8080 hello-world</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or use the provided script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./gradlew assemble # or ./mvnw package if using Maven
$ ./docker-build.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The provided <code>Dockerfile</code> is a multi-stage dockerfile which builds the project in two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A GraalVM official image will build the native image.</p>
</li>
<li>
<p>A typical dockerfile structure will build the final image which in smaller due to layering.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_building_a_native_image_without_using_docker"><a class="anchor" href="#_building_a_native_image_without_using_docker"></a>Building a Native Image Without Using Docker</h4>
<div class="paragraph">
<p>To build your native image without using Docker you need to install GraalVM SDK via the <a href="https://www.graalvm.org/docs/getting-started/">Getting Started</a> instructions or using SDKman:</p>
</div>
<div class="listingblock">
<div class="title">Installing GraalVM 19.3.0 with SDKman</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ sdk install java 19.3.0.r8-grl # or 19.3.0.r11-grl if you want to use JDK 11
$ sdk use java 19.3.0.r8-grl</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>native-image</code> tool was extracted from the base GraalVM distribution. Currently it is available as an early adopter plugin. To install it, run:</p>
</div>
<div class="listingblock">
<div class="title">Installing <code>native-image</code> tool</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ gu install native-image</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Creating native image with Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./gradlew assemble
$ native-image --no-server -cp build/libs/hello-world-0.1-all.jar</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Creating native image with Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./mvnw package
$ native-image --no-server -cp target/hello-world-0.1-all.jar</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Run native image</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./hello-world</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_micronaut_and_graal"><a class="anchor" href="#_understanding_micronaut_and_graal"></a>Understanding Micronaut and Graal</h3>
<div class="paragraph">
<p>Micronaut itself does not rely on reflection or dynamic classloading so works automatically with GraalVM native, however certain third party libraries used by Micronaut may require additional input about uses of reflection.</p>
</div>
<div class="paragraph">
<p>Micronaut includes an annotation processor that helps to handle generating the <code>reflection-config.json</code> metadata that is automatically picked up by the <code>native-image</code> tool:</p>
</div>
<div class="paragraph">
<p>        <div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="gradle">annotationProcessor <span class="hljs-string">'io.micronaut:micronaut-graal'</span></code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="maven">&lt;annotationProcessorPaths&gt;
    &lt;path&gt;
        &lt;groupId&gt;io.micronaut&lt;/groupId&gt;
        &lt;artifactId&gt;micronaut-graal&lt;/artifactId&gt;
    &lt;/path&gt;
&lt;/annotationProcessorPaths&gt;</code></pre>
</div>
</div>
</p>
</div>
<div class="paragraph">
<p>This processor will generate a <code>reflection-config.json</code> file to a file to the <code>META-INF/native-image</code> directory in your build classes directory (<code>target/classes</code> with Maven and typically <code>build/classes/java/main</code> with Gradle) and a <code>native-image.properties</code> file to read this configuration for all classes annotated with either <a href="../api/io/micronaut/core/annotation/Introspected.html">@Introspected</a> or <a href="../api/io/micronaut/core/annotation/TypeHint.html">@TypeHint</a>.</p>
</div>
<div class="paragraph">
<p>For example the following class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package example;
import io.micronaut.core.annotation.*;

@Introspected
class Test {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will result in the public methods and declared constructors of <code>example.Test</code> being included in <code>reflection-config.json</code>.</p>
</div>
<div class="paragraph">
<p>If you have more advanced requirements and only wish to include certain fields or methods, you can use <a href="../api/io/micronaut/core/annotation/ReflectiveAccess.html">@ReflectiveAccess</a> instead which can be present on any constructor, field or method to include only the specific field, constructor or method.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you wish to provide your own <code>reflect.json</code> you can add one to <code>src/main/graal/reflect.json</code> and it will be automatically picked up.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_adding_additional_classes_for_reflective_access"><a class="anchor" href="#_adding_additional_classes_for_reflective_access"></a>Adding Additional Classes for Reflective Access</h3>
<div class="paragraph">
<p>To inform Micronaut of additional classes that should be included in the generated <code>reflect.json</code> file at compilation time you can either annotate a class with <a href="../api/io/micronaut/core/annotation/Introspected.html">@Introspected</a> or <a href="../api/io/micronaut/core/annotation/TypeHint.html">@TypeHint</a>.</p>
</div>
<div class="paragraph">
<p>The former will generate a compile time introspection as well as allowing reflective access and the latter will only allow reflective access and is typically used on a module or <code>Application</code> class to include classes that are needed reflectively. For example, the following is taken from Micronaut&#8217;s Jackson module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@TypeHint(
        value = { <i class="conum" data-value="1"></i><b>(1)</b>
                PropertyNamingStrategy.UpperCamelCaseStrategy.class,
                ArrayList.class,
                LinkedHashMap.class,
                HashSet.class
        },
        accessType = TypeHint.AccessType.ALL_DECLARED_CONSTRUCTORS <i class="conum" data-value="2"></i><b>(2)</b>
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>value</code> member is used to specify which classes require reflection.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>accessType</code> member specifies if only classloading access is needed or whether full reflection on all public members is needed.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_generating_native_images"><a class="anchor" href="#_generating_native_images"></a>Generating Native Images</h3>
<div class="paragraph">
<p>GraalVM&#8217;s <code>native-image</code> command is used to generate native images. You can use this command manually to generate your native image. An example can be seen below.</p>
</div>
<div class="listingblock">
<div class="title">The <code>native-image</code> command</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">native-image --no-server \ <i class="conum" data-value="1"></i><b>(1)</b>
             --class-path build/libs/hello-world-0.1-all.jar <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do not start a background server to generate the native image</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>class-path</code> argument is used to refer to the Micronaut shaded JAR</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the image has been built you can run the application using the native image name:</p>
</div>
<div class="listingblock">
<div class="title">Running the Native Application</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./hello-world
15:15:15.153 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 14ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the advantage of having a native image is startup completes in milliseconds and memory consumption does not include the overhead of the JVM (a native Micronaut application runs with just 20mb of memory).</p>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/configurations.html">&lt;&lt; <strong>12</strong><span>Configurations</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/management.html"><strong>14</strong><span>Management &amp; Monitoring</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="https://docs.micronaut.io/docsassets/js/docs.js"></script>

</body>
</html>
